{% macro loop(community_review, self) %}
<div class="pull-left rating-avg">

    {% if community_review.user_reviews.first() %}
    {{ community_review.get_avg_rating() }}
    {% else %}
    ??
    {% endif %}

</div>

{% if not self %}
<h3>
    
    <a href="{{ url_for('community_review', category_slug=community_review.category.slug, community_review_slug=community_review.slug) }}">{{ community_review.title }}</a>

    {% if session.logged_in %}
    <small> | <a href="{{ url_for('communityreview_model_view.edit_view', id=community_review.id) }}">Edit</a></small>
    {% endif %}

</h3>
{% else %}
<h2>
    
    {{ community_review.title }}

    {% if session.logged_in %}
    <small> | <a href="{{ url_for('communityreview_model_view.edit_view', id=community_review.id) }}">Edit</a></small>
    {% endif %}

</h2>
{% endif %}

<p class="meta">
    Posted on {{ community_review.date_posted.strftime('%b %d, %Y') }}
    {% if community_review.reddit_permalink %}to <a href="{{ community_review.reddit_permalink }}" target="_blank">r/{{ community_review.subreddit }}</a>{% endif %}
</p>

<div class="clear"></div>

<ul class="details">


    {% if community_review.user_reviews.first() %}
    <li><span class="detail-label"># of User Reviews:</span> &nbsp; {{ community_review.get_review_count() }}</li>
    {% endif %}

    <li><span class="detail-label">Reddit Votes:</span> &nbsp; {{ community_review.upvotes }} up, {{ community_review.downvotes}} down</li>

    <li><span class="detail-label">Subreddit:</span> &nbsp; <a href="{{ url_for('subreddit', subreddit=community_review.subreddit) }}">{{ community_review.subreddit }}</a></li>

    <li><span class="detail-label">Category:</span> &nbsp; <a href="{{ url_for('category', category_slug=community_review.category.slug) }}">{{ community_review.category }}</a></li>

    {% if community_review.tags.first() %}
    <li><span class="detail-label">Tagged:</span> &nbsp;
    {% for tag in community_review.tags %}
    <a href="{{ url_for('tag', tag_slug=tag.slug) }}">{{ tag }}</a>{% if not loop.last %} | {% endif %}      
    {% endfor %}
    {% endif %}
    </li>

    {% if community_review.reddit_permalink %}
    <li><span class="detail-label">Status:</span> &nbsp;
    {% if community_review.open_for_comments %}
    <a href="{{ community_review.reddit_permalink }}" target="_blank">Accepting reviews</a>
    {% else %}
    Closed
    {% endif %}
    </li>
    {% endif %}

</ul>

{% if not self %}
<a class="more" href="{{ url_for('community_review', category_slug=community_review.category.slug, community_review_slug=community_review.slug) }}">Read User Reviews</a>
{% endif %}
{% endmacro %}
